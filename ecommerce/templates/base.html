{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>ecommerce</title>
    {% include "base/css.html" %}
  </head>
  <body>
    {% include "base/navbar.html" with brand_name='eCommerce' %}
    <div class="container">
      {% block content %}

      {% endblock %}
    </div>

    {% include "base/js.html" %}
    <script type="text/javascript">

      $(document).ready(function(){
        var productForm = $(".form-product-ajax")
        productForm.submit(function(event){
          event.preventDefault();
          var thisForm = $(this);
          // var actionEndpoint = thisForm.attr("action");
          var actionEndpoint = thisForm.attr("data-endpoint");
          var httpMethod = thisForm.attr("method");
          var formData = thisForm.serialize();

          $.ajax({
            url: actionEndpoint,
            method: httpMethod,
            data: formData,
            success: function(data){
              var submitSpan = thisForm.find(".submit-span")
              if(data.added){
                submitSpan.html("In Cart <button type='submit' class='btn btn-link'>Remove?</button>")
              }
              else{
                submitSpan.html("<button type='submit' class='btn btn-success'>Add to cart</button>")
              }
              var itemCount = $(".cart-item")
              itemCount.text(data.cartItemCount)
              var currentPath = window.location.href
              if(currentPath.indexOf("cart") != -1){
                refreshCart()
              }
            },
            error: function(errorData){
              console.log("Error");
              console.log(errorData);
            }
          })

        })
        function refreshCart(){
          console.log("In current Cart Now")
          var cartTable = $(".cart-table")
          var cartBody  = cartTable.find(".cart-body")
          var currentUrl = window.location.href
          // cartBody.html("<h1>Changed</h1>")
          var productsRows = cartBody.find(".cart-product")


          var refreshCartUrl = '/api/cart/';
          var refreshCartMethod = "GET";
          var data={};
          $.ajax({
            url: refreshCartUrl,
            method: refreshCartMethod,
            data: data,
            success: function(data){
              console.log("Success")
              var hiddenCartRemoveForm = $(".cart-item-remove-form")
              if(data.products.length > 0){
                productsRows.html(" ")
                i=data.products.length
                $.each(data.products,function(index,value){
                  var newCartItemRemove = hiddenCartRemoveForm.clone()
                  newCartItemRemove.css("display","block")
                  newCartItemRemove.find(".cart-item-product-id").val(value.id)
                  cartBody.prepend("<tr><th scope=\"row\">" + i + "</th><td><a href='" + value.url + "'>" + value.name + "</a>" + newCartItemRemove.html() + "</td><td>" + value.price + "</td></tr>")
                  i--
                })
                cartBody.find(".cart-subtotal").text(data.subtotal)
                cartBody.find(".cart-total").text(data.total)
              }
              else{
                window.location.href = currentUrl
              }
            },
            error: function(errorData){
              console.log("Error")
              console.log(errorData)
            }
          })
        }
      })

    </script>
  </body>
</html>
